<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ServeGain â€“ Smart Kitchen Assistant</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:system-ui,sans-serif;background:#f8f9fa;margin:0;padding:0}
    header{background:#1a1a1a;color:white;padding:12px;text-align:center;position:fixed;top:0;width:100%;z-index:10}
    #tally{font-size:18px;font-weight:bold}
    main{margin-top:70px;padding:20px}
    .card{background:white;border-radius:12px;padding:20px;margin:15px 0;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    input,button{font-size:18px;padding:12px;border-radius:8px;border:1px solid #ddd;width:100%;margin:8px 0}
    button{background:#0066ff;color:white;border:none;cursor:pointer}
    button:active{transform:scale(0.98)}
    #voiceBtn{background:#ff4444}
    #output{margin-top:15px;padding:15px;background:#e6f7ff;border-radius:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div>ServeGain</div>
    <div id="tally">Today: 0 orders â€¢ â‚¹0</div>
  </header>

  <main>
    <div class="card">
      <h2>Worker Portal (Free)</h2>
      <input type="text" id="workerName" placeholder="Your name (e.g. Arjun)" />
      <input type="text" id="speechInput" placeholder="Say or type: 2 butter chickenâ€¦" />
      <button id="voiceBtn">ðŸŽ¤ Hold to Speak</button>
      <button id="sendBtn">Log Order</button>
      <div id="output"></div>
    </div>

    <div class="card">
      <h2>Manager â€“ Upload Todayâ€™s Menu (Photo/PDF)</h2>
      <input type="file" id="menuFile" accept="image/*,.pdf" />
      <button id="uploadMenuBtn">Parse & Update Menu</button>
      <div id="uploadResult"></div>
    </div>
  </main>

<script>
const SUPABASE_URL = "https://btxevaguugwvnjtniand.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0eGV2YWd1dWd3dm5qdG5pYW5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzYxOTAsImV4cCI6MjA4MDQxMjE5MH0.R2zJnMQPLmOiWtpfz94HBtoZwksF7p6Ynj6BlGHgCMo"
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
let recognition, isListening = false

// Load todayâ€™s tally
async function refreshTally() {
  const today = new Date().toISOString().slice(0,10)
  const { data } = await supabase.from('orders').select('revenue').gte('timestamp', today)
  const total = data ? data.reduce((a,b)=>a+(b.revenue||0),0) : 0
  const count = data ? data.length : 0
  document.getElementById('tally').textContent = `Today: ${count} orders â€¢ â‚¹${total}`
}
refreshTally()
setInterval(refreshTally, 10000)

// Voice recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)()
  recognition.lang = 'en-IN'
  recognition.continuous = false
  recognition.interimResults = true

  recognition.onresult = e => {
    document.getElementById('speechInput').value = e.results[0][0].transcript
  }
  document.getElementById('voiceBtn').addEventListener('mousedown', ()=>{isListening=true; recognition.start()})
  document.getElementById('voiceBtn').addEventListener('mouseup', ()=>{if(isListening)recognition.stop()})
  document.getElementById('voiceBtn').addEventListener('touchstart', e=>{e.preventDefault();isListening=true;recognition.start()})
  document.getElementById('voiceBtn').addEventListener('touchend', e=>{e.preventDefault();if(isListening)recognition.stop()})
}

// Send order
document.getElementById('sendBtn').onclick = async () => {
  const worker = document.getElementById('workerName').value.trim()
  const text = document.getElementById('speechInput').value.trim()
  if (!worker || !text) return alert("Enter name & order")
  
  const res = await fetch("https://btxevaguugwvnjtniand.supabase.co/functions/v1/smartOrder", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({workerName: worker, text})
  })
  const json = await res.json()
  document.getElementById('output').textContent = json.message || json.error
  if (json.success) {
    document.getElementById('speechInput').value = ""
    refreshTally()
  }
}

// Upload menu
document.getElementById('uploadMenuBtn').onclick = async () => {
  const file = document.getElementById('menuFile').files[0]
  if (!file) return alert("Select a file")
  const base64 = await fileToBase64(file)
  const res = await fetch("https://btxevaguugwvnjtniand.supabase.co/functions/v1/uploadMenu", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({base64, fileName: file.name})
  })
  const json = await res.json()
  document.getElementById('uploadResult').textContent = json.message || json.error
}
function fileToBase64(file) {
  return new Promise((resolve,reject)=>{
    const reader = new FileReader()
    reader.onload = () => resolve(reader.result.split(',')[1])
    reader.onerror = reject
    reader.readAsDataURL(file)
  })
}
</script>
</body>
</html>
